<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Secure Password Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        /* Improved Colors */
        body {
            background-color: #600c63;
            /* Darker shade for sleek UI */
            color: #fff;
        }

        .card {
            background-color: #11a7c2e7;
            /* Darker form background */
            border: none;
        }

        .form-control {
            background-color: #ffffff;
            /* Smooth dark input */
            color: rgb(230, 190, 190);
            border: 1px solid #4a4f57;
            /* Subtle border */
        }

        .form-control:focus {
            border-color: #0d6efd;
            /* Blue highlight */
            box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
        }

        .btn {
            max-width: fit-content;
            align-self: center;
        }

        .hidden-password {
            font-weight: bold;
            color: gray;
        }

        button {
            margin: 5px;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }


        /* Responsive Table */
        .table-container {
            width: 100%;
            overflow-x: auto;
            /* Enables scrolling on small screens */
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 5px;
            /* Reduce padding */
            text-align: center;
            font-size: 14px;
            /* Reduce font size for mobile */
        }

        /* Buttons - Make Smaller */
        button {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Green Show Button */
        .green {
            background-color: green;
            color: white;
            border: none;
        }

        /* Red Delete Button */
        .red {
            background-color: red;
            color: white;
            border: none;
        }

        /* Copy Button */
        .copy-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
        }

        .strength-meter {
            height: 5px;
            width: 100%;
            margin-top: 5px;
        }

        .weak {
            background: red;
        }

        .medium {
            background: orange;
        }

        .strong {
            background: green;
        }

        .chip {
            display: inline-block;
            padding: 8px;
            background-color: #4CAF50;
            color: white;
            border-radius: 20px;
            margin: 5px;
            cursor: pointer;
        }

        /* .timer {
            font-size: 18px;
            font-weight: bold;
            color: yellow;
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        } */

        .timer-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100px;
            /* Circle size */
            height: 100px;
            /* Circle size */
            background-color: #333;
            /* Dark background */
            color: yellow;
            /* Text color */
            font-size: 24px;
            font-weight: bold;
            border-radius: 50%;
            /* Makes it a perfect circle */
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            /* Fixes any shifting issues */
        }


        /* Mobile View - Stack elements */
        @media (max-width: 600px) {

            th,
            td {
                font-size: 12px;
                /* Even smaller for mobile */
                padding: 3px;
            }

            .actions {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }

            button {
                width: 100%;
            }
        }

        #masterKeyStatus {
            font-weight: bold;
            font-size: 18px;
            text-align: center;

            background-color: rebeccapurple;
        }

        #userList2 {
            list-style-type: none;
            padding: 0;
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            position: absolute;
            width: 100%;
        }

        .user-item {
            padding: 8px;
            cursor: pointer;
        }

        .user-item:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>

<body>

    <div class="container mt-4">
        <h4 class="text-center">üîê R' $ecure PaswdMgr</h4>
        <div class="d-flex justify-content-center mb-3">
            <button class="btn btn-secondary" onclick="refreshPage()">üîÑ Refresh</button>
        </div>

        <div class="d-flex justify-content-center">
            <div class="timer-container card p-3 mb-2">
                <p id="timerDisplay"> --:--</p>
            </div>
        </div>

        <div class="card p-3 mb-2" id="masterKeyStatus"></div>

        <!-- Set Master Key Section -->
        <div class="card p-3 mb-4">


            <h5 class="text-center">Set Master Key</h5>
            <div class="mb-3">
                <input type="password" class="form-control" id="masterKey" placeholder="Enter a Master Key">
            </div>
            <div class="mb-3">
                <input type="text" class="form-control" id="hint" placeholder="Enter a Hint (Optional)">
            </div>
            <button class="btn btn-success w-100" onclick="setMasterKey()">Save Master Key</button>

            <!-- Forgot Master Key -->
            <button class="btn btn-warning w-100 mt-2" onclick="recoverMasterKey()">Forgot Master Key?</button>

            <div id="recoveryKeySection"></div>

        </div>


        <!-- Save Password Section -->
        <div class="card p-3 mb-4">
            <h5 class="text-center">Save a Password</h5>
            <div class="mb-3">
                <input type="text" class="form-control" id="website" placeholder="Website/App">
            </div>
            <div class="mb-3">
                <input type="text" class="form-control" id="username" placeholder="Username">
            </div>
            <div class="mb-3">
                <input type="password" class="form-control" id="password" placeholder="Enter Password"
                    oninput="checkPasswordStrength()">
            </div>
            <div class="strength-meter" id="strengthMeter"></div>
            <p id="strengthText"></p>
            <button class="btn btn-info" onclick="savePassword()">Save Securely</button>
            <button class="btn btn-info" onclick="verifyMasterKey()">VerifyKey</button>
        </div>

        <!-- Saved Passwords -->
        <div class="card p-3 mb-4">
            <h5 class="text-center">Saved Usernames</h5>
            <button class="btn btn-secondary w-100 mb-3" onclick="showUsernames()">SHOW MY LIST</button>


            <div id="userList"></div>

            <h5>Reveal Password</h5>
            <input class="form-control" type="text" id="selectedUser" placeholder="Enter Username">
            <button class="btn btn-warning w-100 mb-2" onclick="revealPassword()">REVEAL PASSWORD</button>
            <p>Password: <span id="revealedPassword"></span></p>
            <button class="btn-small green" onclick="copyPassword()">COPY</button>
            <button class="btn-small red" onclick="deletePassword()">DELETE</button>
        </div>

        <!-- <div class="card p-3 mb-3">
            <input type="text" id="searchUser" class="form-control" placeholder="Search Username...">
            <ul id="userList2"></ul>

        </div> -->

        <!-- Retrieve Password Section -->
        <!-- <div class="card p-3 mb-4">
            <h5 class="text-center">Retrieve Password</h5>
            <div class="mb-3">
                <input type="password" class="form-control" id="masterKey1" placeholder="Enter Master Key">
            </div>
            <button class="btn btn-primary w-100 mb-2" onclick="decryptPassword()">Retrieve</button>
            <p class="text-center"><strong>Decrypted Password:</strong> <span id="decryptedData"></span></p>
        </div> -->

        <!-- Backup & Restore Section -->
        <div class="card p-3 mb-4">
            <h5 class="text-center">Backup & Restore</h5>
            <button class="btn btn-success w-100 mb-2" onclick="exportPasswords()">Export Passwords</button>
            <input type="file" id="importFile" class="form-control mb-2" onchange="importPasswords(event)">
            <button class="btn btn-danger w-100 mb-2" onclick="clearPasswords()">Clear All Passwords</button>
        </div>

        <!-- Recovery Options -->
        <div class="card p-3 mb-4">
            <h5 class="text-center">Recovery Options</h5>
            <button class="btn btn-warning w-100" onclick="recoverMasterKey()">Recover Master Key</button>
            <button class="btn btn-primary w-100 mb-2" onclick="showHint()">üîë Show Hint</button>
            <button class="btn btn-warning w-100 mb-2" onclick="sendRecoveryKey()">üì© Send via WhatsApp</button>
            <button class="btn btn-info w-100" onclick="downloadRecoveryKey()">üíæ Save Locally</button>
        </div>

    </div>

</body>

<script>

    window.onload = function () {
        let savedMasterKey = localStorage.getItem("masterKey");
        let masterKeyStatus = document.getElementById("masterKeyStatus");

        if (!savedMasterKey) {
            alert("No Master Key found. Please Set your Master Key");
        }

        //startSessionTimer(sessionTimeout);

        masterKeyStatus.innerHTML = savedMasterKey
            ? `<span style="color: green;">‚úÖ Master Key is set.</span>`
            : `<span style="color: red;">‚ö† No Master Key found.</span>`;
    };




    let passwords = JSON.parse(localStorage.getItem("passwords")) || {};

    //let recoveryKey = generateRecoveryKey();
    //let hashedRecoveryKey = CryptoJS.SHA256(recoveryKey).toString();


    function refreshPage() {
        location.reload();
    }

    function setMasterKey() {
        let masterKey = document.getElementById("masterKey").value;
        if (!masterKey) {
            alert("Master Key cannot be empty!");
            return;
        }


        let hashedKey = CryptoJS.SHA256(masterKey).toString();
        localStorage.setItem("masterKeyHash", hashedKey);
        localStorage.setItem("masterKey", hashedKey);

        // Generate a one-time recovery key
        let recoveryKey = CryptoJS.lib.WordArray.random(16).toString(CryptoJS.enc.Hex);
        let encryptedMasterKey = CryptoJS.AES.encrypt(masterKey, recoveryKey).toString();
        localStorage.setItem("recoveryKey", encryptedMasterKey);

        // Show the recovery key only once
        //showRecoveryKey(recoveryKey);

        let hint = document.getElementById("hint").value.trim(); // Get the value properly

        if (hint) {
            localStorage.setItem("hint", hint); // Save hint
            alert("Hint saved successfully!");
        }

        //alert("Master Key Set Successfully!");

        // Show Recovery Key with Copy Button
        document.getElementById("recoveryKeySection").innerHTML = `
            <div class="alert alert-info text-center">
                <strong>Your Recovery Key:</strong> <span id="generatedRecoveryKey">${recoveryKey}</span>
                <button class="btn btn-sm btn-primary" onclick="copyRecoveryKey()">Copy</button>
            </div>
            <p class="text-danger text-center"><b>Save this key safely! It cannot be recovered later.</b></p>
            `;

        alert("Master Key saved successfully! Make sure to copy and store your Recovery Key.");
    }


    function generateRecoveryKey() {
        let chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        let key = "";
        for (let i = 0; i < 16; i++) {
            key += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return key;
    }

    function copyRecoveryKey() {
        let recoveryKeyText = document.getElementById("generatedRecoveryKey").innerText;

        navigator.clipboard.writeText(recoveryKeyText).then(() => {
            alert("Recovery Key copied to clipboard!");
        }).catch(err => {
            alert("Failed to copy Recovery Key: " + err);
        });
    }



    // üî• 7Ô∏è‚É£ Session Timer & Auto-Logout
    function startSessionTimer(duration) {
        let timer = duration;
        let timerInterval = setInterval(function () {
            let minutes = Math.floor(timer / 60);
            let seconds = timer % 60;
            document.getElementById("timerDisplay").innerText =
                (minutes < 10 ? "0" : "") + minutes + ":" + (seconds < 10 ? "0" : "") + seconds;

            if (--timer < 0) {
                clearInterval(timerInterval);
                alert("‚è≥ Session Expired! Re-enter Master Key.");
                masterKeyValidated = false;
                sessionStorage.removeItem("encryptedMasterKey"); // Clear Master Key on expiry
                verifyMasterKey();
            }
        }, 1000);
    }

    // üîÑ 8Ô∏è‚É£ Reset session timer whenever a new key is entered
    function resetSessionTimer() {
        sessionTimeout = 300; // Reset to 5 minutes
        startSessionTimer(sessionTimeout);
    }


    function refreshPage() {
        location.reload();
    }

    let masterKeyValidated = false;
    let sessionTimeout = 300; // 5 minutes in seconds


    // üèÜ 1Ô∏è‚É£ Master Key Verification
    function verifyMasterKey() {
        let enteredKey = prompt("üîë Enter Master Key:");
        if (enteredKey) {
            masterKeyValidated = true;
            let hashedKey = CryptoJS.SHA256(enteredKey).toString(); // Hash key before storing
            sessionStorage.setItem("encryptedMasterKey", hashedKey);
            alert("‚úÖ Master Key validated!");
            resetSessionTimer(); // Reset session on key entry
        } else {
            masterKeyValidated = false;
        }
    }

    // üöÄ 2Ô∏è‚É£ Get Master Key from Session
    function getMasterKey() {
        let savedKey = sessionStorage.getItem("encryptedMasterKey");

        if (!masterKeyValidated || !savedKey) {
            alert("‚ö† Session Expired! Enter Master Key Again.");
            verifyMasterKey();
            return sessionStorage.getItem("encryptedMasterKey");
        }

        return savedKey;
    }


    // üîí 3Ô∏è‚É£ Encrypt Password
    function encryptPassword(password, masterKey) {
        return CryptoJS.AES.encrypt(password, masterKey).toString();
    }

    // üîì 4Ô∏è‚É£ Decrypt Password
    function decryptPassword(encryptedPassword, masterKey) {
        let bytes = CryptoJS.AES.decrypt(encryptedPassword, masterKey);
        return bytes.toString(CryptoJS.enc.Utf8) || "‚ùå Wrong Master Key!";
    }

    // üì• 5Ô∏è‚É£ Save Password Securely
    function savePassword() {
        let masterKey = getMasterKey();
        if (!masterKey) return;

        let website = document.getElementById("website").value;
        let username = document.getElementById("username").value;
        let password = document.getElementById("password").value;

        if (!website || !username || !password) {
            alert("‚ö† All fields are required!");
            return;
        }

        passwords[username] = encryptPassword(password, masterKey);
        localStorage.setItem("passwords", JSON.stringify(passwords));
        alert("‚úÖ Password saved securely!");
    }

    // üì§ 6Ô∏è‚É£ Reveal Password
    function revealPassword() {
        let masterKey = getMasterKey();
        if (!masterKey) return;

        let user = document.getElementById("selectedUser").value;
        if (passwords[user]) {
            document.getElementById("revealedPassword").innerText = decryptPassword(passwords[user], masterKey);
        } else {
            alert("‚ùå No password found!");
        }
    }




    function checkPasswordStrength() {
        let password = document.getElementById("password")?.value;
        let strengthMeter = document.getElementById("strengthMeter");
        let strengthText = document.getElementById("strengthText");

        if (!strengthMeter || !strengthText) {
            console.error("Strength meter or text element not found!");
            return;
        }

        // Define regex patterns for required characters
        let hasUpperCase = /[A-Z]/.test(password);
        let hasLowerCase = /[a-z]/.test(password);
        let hasNumber = /[0-9]/.test(password);
        let hasSpecialChar = /[/*\-#$%^&*()!@]/.test(password);

        // Check password length
        let isMinLength = password.length >= 6;

        // Count strength based on the presence of each type
        let strength = hasUpperCase + hasLowerCase + hasNumber + hasSpecialChar;

        // If password length is less than 6, consider it weak
        if (!isMinLength) {
            strength = 0;
        }

        // Define strength levels
        const strengthLevels = ["Weak", "Medium", "Strong"];
        const classNames = ["weak", "medium", "strong"];

        let index = Math.min(strength, 2); // Ensure index is between 0-2
        strengthMeter.className = `strength-meter ${classNames[index]}`;
        strengthText.innerText = strengthLevels[index];
    }



    function showUsernames() {
        if (!masterKeyValidated) {
            alert("Session Expired! Enter Master Key Again.");
            return;
        }

        let userListDiv = document.getElementById("userList");

        if (Object.keys(passwords).length === 0) {
            userListDiv.innerHTML = "<tr><td colspan='4' style='text-align:center;'>No saved passwords.</td></tr>";
            return;
        }


        userListDiv.innerHTML = "";
        Object.keys(passwords).forEach(user => {
            let chip = document.createElement("div");
            chip.classList.add("chip");
            chip.innerText = user;
            chip.onclick = () => document.getElementById("selectedUser").value = user;
            userListDiv.appendChild(chip);
        });
    }




    function copyPassword() {
        let password = document.getElementById("revealedPassword").innerText;
        if (!password) return alert("No password to copy!");
        navigator.clipboard.writeText(password);
        alert("Copied to clipboard!");
    }

    function deletePassword() {
        let user = document.getElementById("selectedUser").value;
        if (passwords[user]) {
            delete passwords[user];
            localStorage.setItem("passwords", JSON.stringify(passwords));
            alert("Password deleted!");
        } else {
            alert("User not found!");
        }
    }


    function recoverMasterKey() {
        let enteredRecoveryKey = prompt("Enter your Recovery Key:");
        if (!enteredRecoveryKey) return;

        let encryptedMasterKey = localStorage.getItem("recoveryKey");
        if (!encryptedMasterKey) {
            alert("No recovery key found!");
            return;
        }

        let decryptedMasterKey;
        try {
            decryptedMasterKey = CryptoJS.AES.decrypt(encryptedMasterKey, enteredRecoveryKey).toString(CryptoJS.enc.Utf8);
        } catch (error) {
            alert("Invalid Recovery Key!");
            return;
        }

        if (!decryptedMasterKey) {
            alert("Incorrect Recovery Key!");
            return;
        }

        let newMasterKey = prompt("‚úÖ Success! Recovery Key Validated! Enter a new Master Key");
        if (!newMasterKey) {
            alert("Master Key update canceled.");
            return;
        }

        let hashedNewMasterKey = CryptoJS.SHA256(newMasterKey).toString();
        localStorage.setItem("masterKey", hashedNewMasterKey);
        //sessionStorage.setItem("currentMasterKey", newMasterKey);

        alert("Master Key has been successfully recovered and updated!");
    }

    function exportPasswords() {
        let dataStr = JSON.stringify(passwords, null, 2);
        let blob = new Blob([dataStr], { type: "application/json" });
        let url = URL.createObjectURL(blob);
        let a = document.createElement("a");
        a.href = url;
        a.download = "passwords.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function importPasswords(event) {
        let file = event.target.files[0];
        if (!file) return;

        let reader = new FileReader();
        reader.onload = function (e) {
            passwords = JSON.parse(e.target.result);
            localStorage.setItem("passwords", JSON.stringify(passwords));
            alert("Passwords imported successfully!");
        };
        reader.readAsText(file);
    }


    function clearPasswords() {
        if (confirm("Are you sure you want to clear Key & all saved passwords? This action cannot be undone!")) {
            localStorage.removeItem("passwords");
            localStorage.removeItem("masterKeyHash");
            alert("All saved passwords have been cleared!");
        }
        else {
            alert("Operation canceled. Your passwords are safe.");
        }
    }

    function showHint() {
        let hint = localStorage.getItem("hint");
        alert(hint ? "Your hint: " + hint : "No hint is set.");
    }

    function sendRecoveryKey() {
        let recoveryKey = localStorage.getItem("recoveryKey");
        if (!recoveryKey) {
            alert("No recovery key found!");
            return;
        }

        let whatsappURL = `https://api.whatsapp.com/send?text=Your%20Recovery%20Key:%20${recoveryKey}`;
        window.open(whatsappURL, "_blank");
    }

    function downloadRecoveryKey() {
        let recoveryKey = localStorage.getItem("recoveryKey");
        if (!recoveryKey) {
            alert("No recovery key found!");
            return;
        }

        let blob = new Blob([recoveryKey], { type: "text/plain" });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "recovery_key.txt";
        link.click();
    }

</script>

</html>