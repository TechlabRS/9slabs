<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Tracker - Pro v3.1 (Investments Enhanced)</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

</head>

    <style>
        /* ... (All previous CSS styles remain the same) ... */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            padding-top: 1rem;
            padding-bottom: 70px;
            overscroll-behavior-y: contain;
        }
        .app-header {
            background-color: #007bff; color: white; padding: 1rem 0;
            text-align: center; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky; top: 0; z-index: 1030;
        }
        .app-header h1 { margin-bottom: 0; font-weight: 500; font-size: 1.5rem; }
        .view-container { padding: 0 15px; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card {
            border: none; border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: #ffffff; border-bottom: 1px solid #e9ecef; font-weight: 500;
            border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem;
            padding: 0.75rem 1.25rem;
        }
        .card-body { padding: 1rem; }
        .total-balance-card {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white; text-align: center;
        }
        .total-balance-card h2 { font-size: 1.1rem; margin-bottom: 0.3rem; opacity: 0.9; }
        .total-balance-card .balance-amount { font-size: 2rem; font-weight: 700; }
        .account-balance-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.6rem 0.5rem; border-bottom: 1px solid #f0f2f5; font-size: 0.85rem;
        }
        .account-balance-item:last-child { border-bottom: none; }
        .account-balance-item .account-name { font-weight: 500; color: #495057; }
        .account-balance-item .account-value { font-weight: 700; color: #007bff; }
        .account-balance-item .account-value.hidden-balance .fas { font-size: 1em; }
        .balance-visibility-toggle { margin-bottom: 1rem; display: flex; justify-content: flex-end; }
        .balance-visibility-toggle .btn { font-size: 0.8rem; padding: 0.3rem 0.6rem; }
        .form-control, .custom-select { border-radius: 0.5rem; border: 1px solid #ced4da; font-size:0.9rem; }
        .form-control:focus, .custom-select:focus {
            border-color: #007bff; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .btn { border-radius: 0.5rem; font-weight:500; }
        .transaction-list .list-group-item,
        .investment-list .list-group-item {
            display: flex; justify-content: space-between; align-items: flex-start;
            border-radius: 0.5rem; margin-bottom: 0.5rem; padding: 0.75rem 1.25rem;
            border: 1px solid #e9ecef; position: relative; /* For action buttons */
        }
        .investment-list .list-group-item.redeemed-investment {
            background-color: #f8f9fa; /* Light grey for redeemed */
            opacity: 0.7;
        }
        .investment-item-actions {
            position: absolute; top: 5px; right: 5px; display: flex; gap: 5px;
        }
         .investment-item-actions .btn-sm { padding: 0.15rem 0.3rem; font-size: 0.7rem;}


        .list-item-content .main-info { font-weight: 500; }
        .list-item-content .category-info { font-size: 0.85rem; color: #333; font-weight: 500; }
        .list-item-content .description-info { font-size: 0.75rem; color: #555; font-style: italic; margin-left: 5px;}
        .list-item-content .sub-info { font-size: 0.8rem; color: #6c757d; }
        .list-item-content .account-info,
        .list-item-content .investment-details { font-size: 0.75rem; color: #6c757d; font-style: italic; }
        .list-item-amount .amount { font-weight: 700; }
        .list-item-amount .current-value-label { font-size: 0.7rem; color: #6c757d; display:block; }
        .transaction-income .amount { color: #28a745; }
        .transaction-spend .amount { color: #dc3545; }
        .transaction-transfer .amount { color: #17a2b8; }
        .investment-item .amount { color: #20c997; }
        .investment-item .profit { color: #28a745; }
        .investment-item .loss { color: #dc3545; }
        .item-type-badge {
            font-size: 0.7rem; font-weight: bold; padding: 0.2rem 0.4rem;
            border-radius: 0.25rem; color: white; display: inline-block; margin-top: 4px;
        }
        .status-badge { font-size: 0.7rem; font-weight: bold; padding: 0.2rem 0.4rem; border-radius: 0.25rem; color: white; }
        .status-active { background-color: #28a745; }
        .status-redeemed { background-color: #6c757d; }

        .type-income { background-color: #28a745; }
        .type-spend { background-color: #dc3545; }
        .type-transfer { background-color: #17a2b8; }
        .type-stock { background-color: #fd7e14; }
        .type-mf { background-color: #6f42c1; }
        .type-fd { background-color: #20c997; }
        .type-postal { background-color: #e83e8c; }
        .delete-btn {
            font-size: 0.9rem; color: #dc3545; background: none; border: none;
            cursor: pointer; padding: 0.2rem 0.5rem; align-self: center;
        }
        #transactionModal .form-group-account,
        #transactionModal .form-group-transfer,
        #transactionModal .form-group-category-chips { display: none; }
        .category-chips-container { margin-bottom: 1rem; max-height:150px; overflow-y:auto; }
        .category-chip {
            display: inline-block; padding: 0.3rem 0.6rem; margin: 0.2rem;
            font-size: 0.8rem; border-radius: 1rem; background-color: #e9ecef;
            color: #495057; cursor: pointer; border: 1px solid #ced4da;
            transition: background-color 0.2s, color 0.2s;
        }
        .category-chip.active { background-color: #007bff; color: white; border-color: #007bff;}
        .category-chip:hover:not(.active) { background-color: #d1d9e0; }
        .fab {
            position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px;
            background-color: #007bff; color: white; border-radius: 50%; text-align: center;
            line-height: 56px; font-size: 22px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer; z-index: 1050;
        }
        .fab:hover { background-color: #0056b3; }
        .investment-actions .btn { margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .modal-title { font-weight: 500; font-size: 1.1rem; }
        .filter-controls { margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;}
        .filter-controls .form-control, .filter-controls .custom-select, .filter-controls .btn {
            height: calc(1.5em + .75rem + 2px); font-size: 0.85rem; flex-grow:1;
        }
        .filter-controls .btn { flex-grow:0; }
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            display: flex; justify-content: space-around; align-items: center;
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            padding: 5px 0; height: 60px; z-index: 1040;
        }
        .nav-item {
            flex: 1; text-align: center; color: #888;
            cursor: pointer; padding: 5px 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.7rem;
        }
        .nav-item i { font-size: 1.2rem; margin-bottom: 2px; }
        .nav-item.active { color: #007bff; }
        .nav-item:hover:not(.active) { color: #555; }
        #spendCategoriesChartContainer { max-width: 500px; margin: auto; }
        .settings-actions .btn { margin-top:0.5rem; }
        .profit-loss-info { font-size: 0.9rem; font-weight: bold; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <header class="app-header"><h1 id="appTitle">Dashboard</h1></header>

    <div class="view-container">
        <div class="view active" id="homeView">
            <div class="card total-balance-card">
                <div class="card-body">
                    <h2>Total Balance</h2>
                    <div class="balance-amount" id="totalBalance">$0.00</div>
                </div>
            </div>
            <div class="balance-visibility-toggle">
                <button class="btn btn-outline-secondary btn-sm" id="toggleBalanceVisibility">
                    <i class="fas fa-eye"></i> Hide Amounts
                </button>
            </div>
            <div class="card account-balances-card">
                <div class="card-header">Account Balances</div>
                <div class="card-body" id="accountBalancesList"></div>
            </div>
            <div class="card">
                <div class="card-header">Recent Transactions</div>
                <ul class="list-group list-group-flush" id="recentTransactionsListHome">
                     <li class="list-group-item text-center text-muted">No recent transactions.</li>
                </ul>
            </div>
            <div class="card">
                <div class="card-header">Investment Portfolio Overview</div>
                <div class="card-body" id="investmentSummaryHome">
                    <p class="text-center text-muted">No active investments yet.</p>
                </div>
            </div>
        </div>

        <div class="view" id="transactionsView">
            <div class="card">
                <div class="card-header">Transaction History</div>
                <div class="card-body">
                    <div class="filter-controls">
                        <input type="text" class="form-control" id="searchDescription" placeholder="Search...">
                        <input type="number" class="form-control" id="searchAmount" placeholder="Amount...">
                        <select class="custom-select" id="filterPeriod">
                            <option value="all">All Time</option><option value="today">Today</option>
                            <option value="this_week">This Week</option><option value="this_month">This Month</option>
                            <option value="last_7_days">Last 7 Days</option><option value="last_30_days">Last 30 Days</option>
                            <option value="last_3_months">Last 3 Months</option><option value="last_6_months">Last 6 Months</option>
                            <option value="this_year">This Year</option><option value="last_year">Last Year</option>
                        </select>
                        <button class="btn btn-sm btn-secondary" id="clearFiltersBtn"><i class="fas fa-times"></i> Clear</button>
                    </div>
                    <ul class="list-group list-group-flush transaction-list" id="transactionList">
                        <li class="list-group-item text-center text-muted" id="noTransactionsMessage">No transactions yet.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="view" id="chartsView">
            <div class="card">
                <div class="card-header">Spend Category Breakdown</div>
                <div class="card-body">
                    <div id="spendCategoriesChartContainer">
                        <canvas id="spendCategoriesChart"></canvas>
                    </div>
                     <p id="noSpendDataForChart" class="text-center text-muted" style="display:none;">Not enough spend data to display chart.</p>
                </div>
            </div>
        </div>

        <div class="view" id="investmentsView">
            <div class="card">
                <div class="card-header">Manage Investments</div>
                <div class="card-body investment-actions">
                    <button class="btn btn-outline-warning btn-sm open-investment-modal" data-type="stock"><i class="fas fa-chart-line"></i> Add Stock</button>
                    <button class="btn btn-outline-info btn-sm open-investment-modal" data-type="mf"><i class="fas fa-umbrella-beach"></i> Add MF</button>
                    <button class="btn btn-outline-success btn-sm open-investment-modal" data-type="fd"><i class="fas fa-piggy-bank"></i> Add FD</button>
                    <button class="btn btn-outline-primary btn-sm open-investment-modal" data-type="postal"><i class="fas fa-envelope"></i> Add Postal</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header">My Investments Portfolio</div>
                <ul class="list-group list-group-flush investment-list" id="investmentList">
                    <li class="list-group-item text-center text-muted" id="noInvestmentsMessage">No investments yet.</li>
                </ul>
            </div>
        </div>

        <div class="view" id="settingsView">
            <div class="card">
                <div class="card-header">Data Management</div>
                <div class="card-body settings-actions">
                    <button class="btn btn-info btn-block" id="exportDataBtn"><i class="fas fa-file-export"></i> Export Data</button>
                    <button class="btn btn-warning btn-block" id="importDataTriggerBtn"><i class="fas fa-file-import"></i> Import Data</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                </div>
            </div>
             <div class="card mt-3">
                <div class="card-header">App Info</div>
                <div class="card-body">
                    <p class="text-muted text-center">Money Tracker Pro v3.1</p>
                    <p class="text-muted text-center">&copy; 2024-2025. Your Awesome App.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="fab" id="openTransactionModalFab" data-toggle="modal" data-target="#transactionModal"><i class="fas fa-plus"></i></div>

    <nav class="bottom-nav">
        <div class="nav-item active" data-view="homeView" data-title="Dashboard"><i class="fas fa-home"></i> Home</div>
        <div class="nav-item" data-view="transactionsView" data-title="Transactions"><i class="fas fa-list-alt"></i> Transactions</div>
        <div class="nav-item" data-view="chartsView" data-title="Charts"><i class="fas fa-chart-pie"></i> Charts</div>
        <div class="nav-item" data-view="investmentsView" data-title="Investments"><i class="fas fa-piggy-bank"></i> Investments</div>
        <div class="nav-item" data-view="settingsView" data-title="Settings"><i class="fas fa-cog"></i> Settings</div>
    </nav>

    <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Add New Transaction</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
                <div class="modal-body"><form id="transactionForm">
                    <div class="form-group"><label for="transactionType">Type</label><select class="custom-select" id="transactionType" required><option value="income">Income</option><option value="spend">Spend</option><option value="transfer">Transfer</option></select></div>
                    <div class="form-group form-group-category-chips"><label>Category</label><div class="category-chips-container" id="categoryChipsContainer"></div></div>
                    <div class="form-group form-group-account"><label for="transactionAccount">Account</label><select class="custom-select" id="transactionAccount"><option value="cash">Cash</option><option value="sbi">SBI</option><option value="hdfc">HDFC</option><option value="icici">ICICI</option></select></div>
                    <div class="form-group form-group-transfer"><label for="transferFromAccount">From Account</label><select class="custom-select" id="transferFromAccount"><option value="cash">Cash</option><option value="sbi">SBI</option><option value="hdfc">HDFC</option><option value="icici">ICICI</option></select></div>
                    <div class="form-group form-group-transfer"><label for="transferToAccount">To Account</label><select class="custom-select" id="transferToAccount"><option value="cash">Cash</option><option value="sbi">SBI</option><option value="hdfc">HDFC</option><option value="icici">ICICI</option></select></div>
                    <div class="form-group"><label for="transactionDescription" id="transactionDescriptionLabel">Description</label><input type="text" class="form-control" id="transactionDescription" placeholder="e.g., Salary, Coffee" required></div>
                    <div class="form-group"><label for="transactionAmount">Amount</label><input type="number" class="form-control" id="transactionAmount" placeholder="0.00" step="0.01" min="0.01" required></div>
                    <div class="form-group"><label for="transactionDate">Date</label><input type="date" class="form-control" id="transactionDate" required></div>
                    <input type="hidden" id="selectedCategoryInput">
                    <button type="submit" class="btn btn-primary btn-block">Add Transaction</button>
                </form></div></div></div>
    </div>

    <div class="modal fade" id="investmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Add New Investment</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
            <div class="modal-body"><form id="investmentForm">
                <input type="hidden" id="investmentId"><div class="form-group"><label for="investmentType">Type</label><select class="custom-select" id="investmentType" required><option value="stock">Stock</option><option value="mf">Mutual Fund</option><option value="fd">Fixed Deposit</option><option value="postal">Postal</option></select></div>
                <div class="form-group"><label for="investmentDescription">Description</label><input type="text" class="form-control" id="investmentDescription" required></div><div class="form-group"><label for="investmentDate">Date</label><input type="date" class="form-control" id="investmentDate" required></div>
                <div class="form-group"><label for="investmentAmount">Amount Invested</label><input type="number" class="form-control" id="investmentAmount" step="0.01" min="0.01" required></div>
                <div class="form-group"><label for="investmentSourceAccount">Source Account</label><select class="custom-select" id="investmentSourceAccount" required><option value="">-- Select --</option><option value="cash">Cash</option><option value="sbi">SBI</option><option value="hdfc">HDFC</option><option value="icici">ICICI</option></select></div>
                <div class="form-group"><label for="investmentMaturity">Maturity Info (Optional)</label><input type="text" class="form-control" id="investmentMaturity"></div><button type="submit" class="btn btn-success btn-block">Save Investment</button>
            </form></div></div></div>
    </div>

    <div class="modal fade" id="updateInvestmentValueModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Investment Value</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="updateInvestmentValueForm">
                        <input type="hidden" id="updateValueInvestmentId">
                        <p>Investment: <strong id="updateValueInvestmentName"></strong></p>
                        <div class="form-group">
                            <label for="investmentCurrentValue">New Current Value</label>
                            <input type="number" class="form-control" id="investmentCurrentValue" step="0.01" min="0" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Update Value</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="redeemInvestmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Redeem Investment</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="redeemInvestmentForm">
                        <input type="hidden" id="redeemInvestmentId">
                        <p>Investment: <strong id="redeemInvestmentName"></strong></p>
                        <p>Initial Cost: <strong id="redeemInvestmentInitialCost"></strong></p>
                        <div class="form-group">
                            <label for="investmentRedeemedAmount">Amount Received from Redemption</label>
                            <input type="number" class="form-control" id="investmentRedeemedAmount" step="0.01" min="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="investmentRedemptionDate">Redemption Date</label>
                            <input type="date" class="form-control" id="investmentRedemptionDate" required>
                        </div>
                        <div class="form-group">
                            <label for="redemptionDepositAccount">Deposit to Account</label>
                            <select class="custom-select" id="redemptionDepositAccount" required>
                                <option value="">-- Select Account --</option>
                                </select>
                        </div>
                        <div id="redeemProfitLossInfo" class="profit-loss-info text-center mb-2"></div>
                        <button type="submit" class="btn btn-success btn-block">Confirm Redemption</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    // ... (all previous DOM elements from V3) ...
    const appTitleEl = document.getElementById('appTitle');
    const views = document.querySelectorAll('.view');
    const navItems = document.querySelectorAll('.bottom-nav .nav-item');
    const recentTransactionsListHomeEl = document.getElementById('recentTransactionsListHome');
    const investmentSummaryHomeEl = document.getElementById('investmentSummaryHome');
    const spendCategoriesChartCanvas = document.getElementById('spendCategoriesChart')?.getContext('2d');
    const noSpendDataForChartEl = document.getElementById('noSpendDataForChart');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const importFileEl = document.getElementById('importFile');
    const importDataTriggerBtn = document.getElementById('importDataTriggerBtn');
    const transactionForm = document.getElementById('transactionForm');
    const transactionListEl = document.getElementById('transactionList');
    const totalBalanceEl = document.getElementById('totalBalance');
    const transactionDateEl = document.getElementById('transactionDate');
    const noTransactionsMessageEl = document.getElementById('noTransactionsMessage');
    const transactionTypeEl = document.getElementById('transactionType');
    const accountGroupEl = document.querySelector('#transactionModal .form-group-account');
    const transferGroupEls = document.querySelectorAll('#transactionModal .form-group-transfer');
    const categoryChipsGroupEl = document.querySelector('#transactionModal .form-group-category-chips');
    const categoryChipsContainerEl = document.getElementById('categoryChipsContainer');
    const transactionDescriptionLabelEl = document.getElementById('transactionDescriptionLabel');
    const selectedCategoryInputEl = document.getElementById('selectedCategoryInput');
    const accountBalancesListEl = document.getElementById('accountBalancesList');
    const toggleBalanceVisibilityBtn = document.getElementById('toggleBalanceVisibility');
    const investmentForm = document.getElementById('investmentForm');
    const investmentListEl = document.getElementById('investmentList');
    const noInvestmentsMessageEl = document.getElementById('noInvestmentsMessage');
    const investmentModalJQ = $('#investmentModal');
    const investmentTypeSelect = document.getElementById('investmentType');
    const investmentDateEl = document.getElementById('investmentDate');
    const investmentSourceAccountEl = document.getElementById('investmentSourceAccount');
    const searchDescriptionEl = document.getElementById('searchDescription');
    const searchAmountEl = document.getElementById('searchAmount');
    const filterPeriodEl = document.getElementById('filterPeriod');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');

    // New Modals' forms and elements
    const updateInvestmentValueForm = document.getElementById('updateInvestmentValueForm');
    const updateValueInvestmentIdEl = document.getElementById('updateValueInvestmentId');
    const updateValueInvestmentNameEl = document.getElementById('updateValueInvestmentName');
    const investmentCurrentValueEl = document.getElementById('investmentCurrentValue');

    const redeemInvestmentForm = document.getElementById('redeemInvestmentForm');
    const redeemInvestmentIdEl = document.getElementById('redeemInvestmentId');
    const redeemInvestmentNameEl = document.getElementById('redeemInvestmentName');
    const redeemInvestmentInitialCostEl = document.getElementById('redeemInvestmentInitialCost');
    const investmentRedeemedAmountEl = document.getElementById('investmentRedeemedAmount');
    const investmentRedemptionDateEl = document.getElementById('investmentRedemptionDate');
    const redemptionDepositAccountEl = document.getElementById('redemptionDepositAccount');
    const redeemProfitLossInfoEl = document.getElementById('redeemProfitLossInfo');


    // --- App State & Config ---
    // ... (accountNames, spendCategories, balancesVisible - same as V3) ...
    const accountNames = { cash: 'Cash', sbi: 'SBI', hdfc: 'HDFC', icici: 'ICICI' };
    const accountKeys = Object.keys(accountNames);
    const spendCategories = [ /* ... same expanded list ... */
        'Bills', 'CC Bills', 'Cloths', 'Education', 'Entertainment', 'EMI', 'Fuel', 'Travel', 'Shopping', 'Foods', 'Drinks',
        'Parties', 'Vacation', 'Gifts', 'Groceries', 'Homes & Utilities', 'Health & Medicine', 'Insurance', 'Investment Expense', 'Labs & Tests', 'Personal Care', 'Pets', 'Rent', 'Subscriptions', 'Others'
    ];
    let balancesVisible = true;
    let transactions = JSON.parse(localStorage.getItem('transactions_multi_v5')) || [];
    let investments = JSON.parse(localStorage.getItem('investments_data_v4')) || []; // Updated key
    const investmentTypeNames = { stock: 'Stock', mf: 'Mutual Fund', fd: 'Fixed Deposit', postal: 'Postal' };
    let spendChartInstance = null;

    // --- Utility Functions ---
    function saveTransactions() { localStorage.setItem('transactions_multi_v5', JSON.stringify(transactions)); }
    function saveInvestments() { localStorage.setItem('investments_data_v4', JSON.stringify(investments)); } // Updated key
    function formatDate(dateString) { return new Date(dateString).toLocaleDateString('en-CA'); }
    function setDefaultDate(dateElement) { if(dateElement) dateElement.valueAsDate = new Date(); }
    function populateAccountDropdown(selectElement) {
        if (!selectElement) return;
        selectElement.innerHTML = '<option value="">-- Select Account --</option>'; // Default empty option
        accountKeys.forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = accountNames[key];
            selectElement.appendChild(option);
        });
    }


    // --- View Management ---
    // ... (showView - same as V3) ...
    function showView(viewId, title) {
        views.forEach(view => view.classList.remove('active'));
        document.getElementById(viewId)?.classList.add('active');
        navItems.forEach(item => {
            item.classList.toggle('active', item.dataset.view === viewId);
        });
        if(appTitleEl) appTitleEl.textContent = title;
        if (viewId === 'chartsView') renderSpendChart();
        if (viewId === 'homeView') renderHomePageSummaries();
        if (viewId === 'investmentsView') renderInvestmentList(); // Ensure list is fresh
    }
    navItems.forEach(item => { item.addEventListener('click', () => { showView(item.dataset.view, item.dataset.title); }); });


    // --- Chart Rendering ---
    // ... (prepareChartData, renderSpendChart - same as V3) ...
    function prepareChartData() { /* ... */ 
        const categorySpends = {};
        transactions.filter(t => t.type === 'spend' && t.category).forEach(t => {
            categorySpends[t.category] = (categorySpends[t.category] || 0) + t.amount;
        });
        const labels = Object.keys(categorySpends);
        const data = Object.values(categorySpends);
        const backgroundColors = labels.map(() => `hsl(${Math.random() * 360}, 70%, 70%)`);
        return { labels, data, backgroundColors };
    }
    function renderSpendChart() { /* ... */
        if (!spendCategoriesChartCanvas) return;
        const { labels, data, backgroundColors } = prepareChartData();
        if (noSpendDataForChartEl) noSpendDataForChartEl.style.display = (labels.length === 0) ? 'block' : 'none';
        if (spendCategoriesChartCanvas.parentElement) spendCategoriesChartCanvas.parentElement.style.display = (labels.length > 0) ? 'block' : 'none';
        if (labels.length === 0) { if(spendChartInstance) spendChartInstance.destroy(); spendChartInstance = null; return; }
        if (spendChartInstance) spendChartInstance.destroy();
        spendChartInstance = new Chart(spendCategoriesChartCanvas, {
            type: 'doughnut', data: { labels: labels, datasets: [{ label: 'Spend by Category', data: data, backgroundColor: backgroundColors, borderColor: '#fff', borderWidth: 1, hoverOffset: 4 }] },
            options: { responsive: true, maintainAspectRatio: true, animation: { animateScale: true, animateRotate: true }, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 }, boxWidth:20, padding:15 } }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) label += ': '; if (context.parsed !== null) label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed); const total = context.dataset.data.reduce((acc, val) => acc + val, 0); const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) + '%' : '0%'; label += ` (${percentage})`; return label;}}}}}
        });
    }

    // --- Export/Import Data ---
    // ... (exportData, importData - same as V3, ensure new investment fields are handled) ...
    function exportData() { /* ... */
        const dataToExport = {
            transactions: transactions, investments: investments, appVersion: 'money_tracker_pro_v3.1_export_v1', exportDate: new Date().toISOString()
        };
        const jsonData = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url;
        a.download = `money_tracker_data_${formatDate(new Date().toISOString().slice(0,10))}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); alert('Data exported successfully!');
    }
    function importData(event) { /* ... */
        const file = event.target.files[0]; if (!file) return; if (file.type !== "application/json") { alert("Invalid file type."); return; }
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                // Basic validation for new investment fields
                const isValidInvestment = (inv) => typeof inv.id === 'number' && typeof inv.description === 'string' && typeof inv.amount === 'number' && (inv.status === 'active' || inv.status === 'redeemed');
                if (importedData && Array.isArray(importedData.transactions) && Array.isArray(importedData.investments) && importedData.investments.every(isValidInvestment)) {
                    if (confirm('This will replace ALL current data. Are you sure?')) {
                        transactions = importedData.transactions.map(t => ({...t, amount: parseFloat(t.amount) })); // Ensure amount is number
                        investments = importedData.investments.map(inv => ({
                            ...inv,
                            amount: parseFloat(inv.amount),
                            currentValue: inv.currentValue ? parseFloat(inv.currentValue) : null,
                            redeemedAmount: inv.redeemedAmount ? parseFloat(inv.redeemedAmount) : null,
                            profitOrLoss: inv.profitOrLoss ? parseFloat(inv.profitOrLoss) : null,
                            status: inv.status || 'active' // Default to active if missing
                        }));
                        saveTransactions(); saveInvestments(); renderAllContent(); showView('homeView', 'Dashboard'); alert('Data imported successfully!');
                    }
                } else { alert('Invalid data structure in imported file or investment data error.'); }
            } catch (error) { console.error("Import Error:", error); alert('Error importing data.'); }
            finally { importFileEl.value = ''; }
        };
        reader.readAsText(file);
    }
    if (exportDataBtn) exportDataBtn.addEventListener('click', exportData);
    if (importDataTriggerBtn) importDataTriggerBtn.addEventListener('click', () => importFileEl.click());
    if (importFileEl) importFileEl.addEventListener('change', importData);


    // --- Category Chips & Transaction Form Logic ---
    // ... (populateCategoryChips, updateTransactionFormFields - same as V3) ...
    function populateCategoryChips() { /* ... */ 
        if (!categoryChipsContainerEl) return; categoryChipsContainerEl.innerHTML = '';
        spendCategories.sort().forEach(cat => { const chip = document.createElement('span'); chip.classList.add('category-chip'); chip.textContent = cat; chip.dataset.category = cat; chip.addEventListener('click', () => { document.querySelectorAll('#categoryChipsContainer .category-chip').forEach(c => c.classList.remove('active')); chip.classList.add('active'); selectedCategoryInputEl.value = cat; }); categoryChipsContainerEl.appendChild(chip); });
    }
    function updateTransactionFormFields() { /* ... */ 
        if (!transactionTypeEl || !accountGroupEl || !transferGroupEls.length || !categoryChipsGroupEl || !transactionDescriptionLabelEl) return;
        const type = transactionTypeEl.value; accountGroupEl.style.display = (type === 'income' || type === 'spend') ? 'block' : 'none'; transferGroupEls.forEach(el => el.style.display = (type === 'transfer') ? 'block' : 'none'); categoryChipsGroupEl.style.display = (type === 'spend') ? 'block' : 'none'; transactionDescriptionLabelEl.textContent = (type === 'spend') ? 'Notes / Specifics (Optional)' : 'Description'; if (type !== 'spend') { selectedCategoryInputEl.value = ''; document.querySelectorAll('#categoryChipsContainer .category-chip.active').forEach(c => c.classList.remove('active')); }
    }
    if (transactionTypeEl) transactionTypeEl.addEventListener('change', updateTransactionFormFields);

    // --- Balance Calculations & Rendering ---
    // ... (calculateAllBalances, renderAccountBalances, toggleBalanceVisibilityBtn listener - same as V3) ...
    function calculateAllBalances() { /* ... */ 
        const accBalances = {}; accountKeys.forEach(key => accBalances[key] = 0);
        transactions.forEach(t => { if (t.type === 'income') accBalances[t.account] = (accBalances[t.account] || 0) + t.amount; else if (t.type === 'spend') accBalances[t.account] = (accBalances[t.account] || 0) - t.amount; else if (t.type === 'transfer') { accBalances[t.fromAccount] = (accBalances[t.fromAccount] || 0) - t.amount; accBalances[t.toAccount] = (accBalances[t.toAccount] || 0) + t.amount; }});
        return accBalances;
    }
    function renderAccountBalances() { /* ... */ 
        if(!accountBalancesListEl || !totalBalanceEl) return; const balances = calculateAllBalances(); accountBalancesListEl.innerHTML = ''; let totalOverallBalance = 0;
        accountKeys.forEach(key => { const balance = balances[key] || 0; totalOverallBalance += balance; const item = document.createElement('div'); item.classList.add('account-balance-item'); const valueDisplay = balancesVisible ? `$${balance.toFixed(2)}` : `<i class="fas fa-eye-slash"></i>`; item.innerHTML = `<span class="account-name">${accountNames[key]}</span><span class="account-value ${!balancesVisible ? 'hidden-balance' : ''}">${valueDisplay}</span>`; accountBalancesListEl.appendChild(item); });
        totalBalanceEl.textContent = `$${totalOverallBalance.toFixed(2)}`; totalBalanceEl.style.color = totalOverallBalance < 0 ? '#dc3545' : 'white';
    }
    if (toggleBalanceVisibilityBtn) { /* ... */ 
        toggleBalanceVisibilityBtn.addEventListener('click', () => { balancesVisible = !balancesVisible; toggleBalanceVisibilityBtn.innerHTML = balancesVisible ? '<i class="fas fa-eye"></i> Hide Amounts' : '<i class="fas fa-eye-slash"></i> Show Amounts'; renderAccountBalances(); });
    }

    // --- Date Filter & Transaction Filtering ---
    // ... (getFilterDateRange, filterAndSearchTransactions - same as V3) ...
    function getFilterDateRange(period) { /* ... */ 
        const now = new Date(); let start = new Date(now); let end = new Date(now); start.setHours(0,0,0,0); end.setHours(23,59,59,999);
        switch (period) { case 'today': break; case 'this_week': const day = start.getDay(); start.setDate(start.getDate() - day + (day === 0 ? -6 : 1)); end.setDate(start.getDate() + 6); break; case 'this_month': start.setDate(1); end = new Date(start.getFullYear(), start.getMonth() + 1, 0, 23,59,59,999); break; case 'last_7_days': start.setDate(now.getDate() - 6); break; case 'last_30_days': start.setDate(now.getDate() - 29); break; case 'last_3_months': start = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate()); break; case 'last_6_months': start = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate()); break; case 'this_year': start.setMonth(0,1); end.setMonth(11,31); break; case 'last_year': const y = now.getFullYear() - 1; start = new Date(y,0,1); end = new Date(y,11,31,23,59,59,999); break; default: return null; }
        return { start, end };
    }
    function filterAndSearchTransactions() { /* ... */ 
        let filtered = [...transactions]; const descQuery = searchDescriptionEl ? searchDescriptionEl.value.toLowerCase() : ""; const amountQuery = searchAmountEl && searchAmountEl.value ? parseFloat(searchAmountEl.value) : null; const period = filterPeriodEl ? filterPeriodEl.value : "all";
        if (descQuery) filtered = filtered.filter(t => (t.description && t.description.toLowerCase().includes(descQuery)) || (t.category && t.category.toLowerCase().includes(descQuery))); if (amountQuery !== null && !isNaN(amountQuery)) filtered = filtered.filter(t => t.amount === amountQuery); const dateRange = getFilterDateRange(period); if (dateRange) filtered = filtered.filter(t => { const d = new Date(t.date); return d >= dateRange.start && d <= dateRange.end; });
        return filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
    }

    // --- Transaction Rendering (Full List) ---
    // ... (renderFullTransactionList - same as V3) ...
    function renderFullTransactionList() { /* ... */
        if(!transactionListEl) return; const transactionsToRender = filterAndSearchTransactions(); transactionListEl.innerHTML = '';
        if (transactionsToRender.length === 0) { if (noTransactionsMessageEl) { noTransactionsMessageEl.textContent = transactions.length > 0 ? "No transactions match your filters." : "No transactions yet."; noTransactionsMessageEl.style.display = 'block'; transactionListEl.appendChild(noTransactionsMessageEl); }}
        else { if (noTransactionsMessageEl) noTransactionsMessageEl.style.display = 'none'; transactionsToRender.forEach(t => { let sign = t.type === 'income' ? '+' : (t.type === 'spend' ? '-' : ''); let accInfo = t.type === 'transfer' ? `From ${accountNames[t.fromAccount]||'N/A'} to ${accountNames[t.toAccount]||'N/A'}` : `${t.type === 'income' ? 'To' : 'From'} ${accountNames[t.account]||'N/A'}`; let categoryDisplay = t.type === 'spend' && t.category ? `<span class="category-info">${t.category}</span>${t.description ? `<span class="description-info">(${t.description})</span>`:''}` : `<span class="main-info">${t.description || 'N/A'}</span>`; const item = document.createElement('li'); item.classList.add('list-group-item', `transaction-${t.type}`); item.innerHTML = `<div class="list-item-content">${categoryDisplay}<div class="sub-info">${formatDate(t.date)}</div><div class="account-info">${accInfo}</div></div><div class="list-item-amount text-right"><span class="amount">${sign}$${t.amount.toFixed(2)}</span><div><span class="item-type-badge type-${t.type}">${t.type[0].toUpperCase() + t.type.slice(1)}</span></div></div><button class="delete-btn" data-id="${t.id}" data-type="transaction">&times;</button>`; transactionListEl.appendChild(item); }); }
    }
    
    // --- Home Page Summaries (Updated for Investments) ---
    function renderHomePageSummaries() {
        // Recent Transactions (same as V3)
        if (recentTransactionsListHomeEl) { /* ... */
            recentTransactionsListHomeEl.innerHTML = ''; const recent = [...transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);
            if(recent.length === 0) { recentTransactionsListHomeEl.innerHTML = '<li class="list-group-item text-center text-muted">No recent transactions.</li>'; }
            else { recent.forEach(t => { let sign = t.type === 'income' ? '+' : (t.type === 'spend' ? '-' : ''); let categoryDisplay = t.type === 'spend' && t.category ? `<span class="category-info">${t.category}</span>${t.description ? `<span class="description-info 짧게">(${t.description.substring(0,20)+(t.description.length > 20 ? '...' : '')})</span>`:''}` : `<span class="main-info">${(t.description || 'N/A').substring(0,25)+( (t.description||'').length > 25 ? '...':'')}</span>`; const item = document.createElement('li'); item.classList.add('list-group-item'); item.innerHTML = `<div class="d-flex w-100 justify-content-between"><div style="font-size:0.85rem;">${categoryDisplay}<small class="d-block text-muted">${formatDate(t.date)}</small></div><small class="text-${t.type === 'income' ? 'success' : (t.type === 'spend' ? 'danger' : 'info')}">${sign}$${t.amount.toFixed(2)}</small></div>`; recentTransactionsListHomeEl.appendChild(item); }); }
        }

        // Investment Summary (Updated)
        if (investmentSummaryHomeEl) {
            const activeInvestments = investments.filter(inv => inv.status === 'active');
            if (activeInvestments.length === 0) {
                investmentSummaryHomeEl.innerHTML = '<p class="text-center text-muted">No active investments yet.</p>';
            } else {
                const totalInitialCostActive = activeInvestments.reduce((sum, inv) => sum + inv.amount, 0);
                const totalCurrentValueActive = activeInvestments.reduce((sum, inv) => sum + (inv.currentValue !== null && inv.currentValue !== undefined ? inv.currentValue : inv.amount), 0);
                investmentSummaryHomeEl.innerHTML = `
                    <p class="text-center mb-1"><strong>Active Investments:</strong> ${activeInvestments.length}</p>
                    <p class="text-center mb-1"><strong>Total Initial Cost (Active):</strong> $${totalInitialCostActive.toFixed(2)}</p>
                    <p class="text-center"><strong>Total Current Value (Active):</strong> $${totalCurrentValueActive.toFixed(2)}</p>
                `;
            }
        }
    }

    // --- Investment Rendering (Updated for new fields and actions) ---
    function renderInvestmentList() {
        if (!investmentListEl) return;
        investmentListEl.innerHTML = '';
        const sortedInvestments = [...investments].sort((a, b) => {
            // Sort active ones first, then by date
            if (a.status === 'active' && b.status !== 'active') return -1;
            if (a.status !== 'active' && b.status === 'active') return 1;
            return new Date(b.date) - new Date(a.date);
        });

        if (sortedInvestments.length === 0) {
            if (noInvestmentsMessageEl) { noInvestmentsMessageEl.style.display = 'block'; investmentListEl.appendChild(noInvestmentsMessageEl); }
        } else {
            if (noInvestmentsMessageEl) noInvestmentsMessageEl.style.display = 'none';
            sortedInvestments.forEach(inv => {
                const item = document.createElement('li');
                item.classList.add('list-group-item', 'investment-item');
                if (inv.status === 'redeemed') item.classList.add('redeemed-investment');

                let valueDisplay = `<span class="amount">$${inv.amount.toFixed(2)}</span> <small>(Invested)</small>`;
                if (inv.status === 'active' && (inv.currentValue !== null && inv.currentValue !== undefined)) {
                    valueDisplay += `<br><span class="amount ${inv.currentValue >= inv.amount ? 'text-success' : 'text-danger'}">$${inv.currentValue.toFixed(2)}</span> <small class="current-value-label">(Current)</small>`;
                } else if (inv.status === 'redeemed') {
                     valueDisplay = `<span class="amount text-muted">$${inv.amount.toFixed(2)}</span> <small>(Invested)</small><br><span class="amount">$${(inv.redeemedAmount || 0).toFixed(2)}</span> <small>(Redeemed)</small>`;
                }

                let profitLossDisplay = '';
                if (inv.status === 'redeemed' && (inv.profitOrLoss !== null && inv.profitOrLoss !== undefined)) {
                    const pnlClass = inv.profitOrLoss >= 0 ? 'profit' : 'loss';
                    profitLossDisplay = `<div class="investment-details ${pnlClass}">Profit/Loss: $${inv.profitOrLoss.toFixed(2)}</div>`;
                }
                
                let actionButtonsHtml = '';
                if (inv.status === 'active') {
                    actionButtonsHtml = `
                        <div class="investment-item-actions">
                            <button class="btn btn-info btn-sm update-value-btn" data-id="${inv.id}" title="Update Value"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-success btn-sm redeem-btn" data-id="${inv.id}" title="Redeem"><i class="fas fa-hand-holding-usd"></i></button>
                        </div>
                    `;
                }

                item.innerHTML = `
                    <div class="list-item-content">
                        <div class="main-info">${inv.description} <span class="status-badge status-${inv.status}">${inv.status}</span></div>
                        <div class="sub-info">Type: ${investmentTypeNames[inv.type] || 'N/A'} | Invested: ${formatDate(inv.date)}</div>
                        ${inv.status === 'active' && inv.maturityInfo ? `<div class="investment-details">Maturity: ${inv.maturityInfo}</div>` : ''}
                        ${inv.status === 'redeemed' && inv.redemptionDate ? `<div class="investment-details">Redeemed: ${formatDate(inv.redemptionDate)}</div>` : ''}
                        ${profitLossDisplay}
                        <div class="investment-details">From Acct: ${accountNames[inv.sourceAccount] || 'N/A'}</div>
                    </div>
                    <div class="list-item-amount text-right">
                        ${valueDisplay}
                    </div>
                    ${actionButtonsHtml}
                    <button class="delete-btn" data-id="${inv.id}" data-type="investment" style="position: absolute; bottom: 5px; right: 5px;">&times;</button>
                `;
                investmentListEl.appendChild(item);
            });
        }
    }

    // --- Event Handlers for New Investment Modals ---
    document.body.addEventListener('click', function(e) {
        const target = e.target.closest('.update-value-btn') || e.target.closest('.redeem-btn');
        if (!target) return;

        const investmentId = parseInt(target.dataset.id);
        const investment = investments.find(inv => inv.id === investmentId);
        if (!investment) return;

        if (target.classList.contains('update-value-btn')) {
            updateValueInvestmentIdEl.value = investment.id;
            updateValueInvestmentNameEl.textContent = investment.description;
            investmentCurrentValueEl.value = investment.currentValue !== null && investment.currentValue !== undefined ? investment.currentValue.toFixed(2) : '';
            $('#updateInvestmentValueModal').modal('show');
        } else if (target.classList.contains('redeem-btn')) {
            redeemInvestmentIdEl.value = investment.id;
            redeemInvestmentNameEl.textContent = investment.description;
            redeemInvestmentInitialCostEl.textContent = `$${investment.amount.toFixed(2)}`;
            investmentRedeemedAmountEl.value = ''; // Clear previous value
            setDefaultDate(investmentRedemptionDateEl);
            populateAccountDropdown(redemptionDepositAccountEl);
            redeemProfitLossInfoEl.textContent = ''; // Clear profit/loss info
            $('#redeemInvestmentModal').modal('show');
        }
    });
    
    if(investmentRedeemedAmountEl) { // Calculate P/L on input in redeem modal
        investmentRedeemedAmountEl.addEventListener('input', function() {
            const investmentId = parseInt(redeemInvestmentIdEl.value);
            const investment = investments.find(inv => inv.id === investmentId);
            if (!investment) return;
            const redeemedAmountVal = parseFloat(this.value);
            if (!isNaN(redeemedAmountVal)) {
                const profitLoss = redeemedAmountVal - investment.amount;
                redeemProfitLossInfoEl.textContent = `Est. Profit/Loss: $${profitLoss.toFixed(2)}`;
                redeemProfitLossInfoEl.className = `profit-loss-info text-center mb-2 ${profitLoss >= 0 ? 'text-success' : 'text-danger'}`;
            } else {
                redeemProfitLossInfoEl.textContent = '';
            }
        });
    }


    if (updateInvestmentValueForm) {
        updateInvestmentValueForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const id = parseInt(updateValueInvestmentIdEl.value);
            const currentValue = parseFloat(investmentCurrentValueEl.value);

            const investmentIndex = investments.findIndex(inv => inv.id === id);
            if (investmentIndex > -1 && !isNaN(currentValue)) {
                investments[investmentIndex].currentValue = currentValue;
                saveInvestments();
                renderAllContent();
                $('#updateInvestmentValueModal').modal('hide');
            } else {
                alert('Invalid current value.');
            }
        });
    }

    if (redeemInvestmentForm) {
        redeemInvestmentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const id = parseInt(redeemInvestmentIdEl.value);
            const redeemedAmount = parseFloat(investmentRedeemedAmountEl.value);
            const redemptionDate = investmentRedemptionDateEl.value;
            const depositAccount = redemptionDepositAccountEl.value;

            const investmentIndex = investments.findIndex(inv => inv.id === id);
            if (investmentIndex > -1 && !isNaN(redeemedAmount) && redemptionDate && depositAccount) {
                const investment = investments[investmentIndex];
                const profitLoss = redeemedAmount - investment.amount;

                investment.status = 'redeemed';
                investment.redeemedAmount = redeemedAmount;
                investment.redemptionDate = redemptionDate;
                investment.profitOrLoss = profitLoss;
                investment.currentValue = null; // No longer relevant

                // Create income transaction
                const incomeTransaction = {
                    id: Date.now(),
                    type: 'income',
                    description: `Redemption: ${investment.description} (P/L: $${profitLoss.toFixed(2)})`,
                    amount: redeemedAmount,
                    date: redemptionDate,
                    account: depositAccount,
                    category: 'Investment Income' // Or make this selectable/generic
                };
                transactions.push(incomeTransaction);
                
                saveInvestments();
                saveTransactions();
                renderAllContent();
                $('#redeemInvestmentModal').modal('hide');
            } else {
                alert('Please fill all fields correctly for redemption.');
            }
        });
    }


    // --- Original Event Handlers (Transaction, Investment Add, Delete, Filters) ---
    // ... (transactionForm submit - same as V3) ...
    if (transactionForm) { /* ... */ 
        transactionForm.addEventListener('submit', (e) => { e.preventDefault(); const type = transactionTypeEl.value; const descriptionInputVal = document.getElementById('transactionDescription').value; const amount = parseFloat(document.getElementById('transactionAmount').value); const date = transactionDateEl.value; const category = (type === 'spend') ? selectedCategoryInputEl.value : null; const description = descriptionInputVal; let acc, fromAcc, toAcc, isValid = false; if (type === 'income' || type === 'spend') { acc = document.getElementById('transactionAccount').value; if (type === 'spend' && !category && !description) { alert('For spend, select a category or provide notes.'); return; } if (amount > 0 && date && acc && (description || category) ) isValid = true; } else if (type === 'transfer') { fromAcc = document.getElementById('transferFromAccount').value; toAcc = document.getElementById('transferToAccount').value; if (description && amount > 0 && date && fromAcc && toAcc && fromAcc !== toAcc) isValid = true; else if (fromAcc === toAcc) { alert('From and To accounts cannot be the same.'); return; } } if (isValid) { const newTransaction = { id: Date.now(), type, description, amount, date, category }; if (type === 'income' || type === 'spend') newTransaction.account = acc; else if (type === 'transfer') { newTransaction.fromAccount = fromAcc; newTransaction.toAccount = toAcc; delete newTransaction.category; } transactions.push(newTransaction); saveTransactions(); renderAllContent(); transactionForm.reset(); selectedCategoryInputEl.value = ''; document.querySelectorAll('#categoryChipsContainer .category-chip.active').forEach(c => c.classList.remove('active')); setDefaultDate(transactionDateEl); updateTransactionFormFields(); $('#transactionModal').modal('hide'); } else alert('Please fill all required fields correctly.'); });
    }

    // ... ('.open-investment-modal' click - same as V3) ...
    document.querySelectorAll('.open-investment-modal').forEach(button => { /* ... */ 
        button.addEventListener('click', function() { const type = this.dataset.type; if(investmentForm) investmentForm.reset(); if(investmentTypeSelect) investmentTypeSelect.value = type; setDefaultDate(investmentDateEl); if(investmentSourceAccountEl) investmentSourceAccountEl.value = ""; document.getElementById('investmentId').value = ''; investmentModalJQ.modal('show'); });
    });

    // ... (investmentForm submit - updated to set initial status and clear currentValue) ...
    if(investmentForm) {
        investmentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('investmentId').value; // Not used for new, but for potential future edit
            const type = investmentTypeSelect.value;
            const description = document.getElementById('investmentDescription').value;
            const date = investmentDateEl.value;
            const amount = parseFloat(document.getElementById('investmentAmount').value);
            const maturityInfo = document.getElementById('investmentMaturity').value;
            const sourceAccount = investmentSourceAccountEl.value;

            if (!description || !date || isNaN(amount) || amount <= 0 || !sourceAccount) {
                alert('Fill all required fields and source account.'); return;
            }
            // For new investments
            const newInvestment = {
                id: Date.now(), type, description, date, amount, maturityInfo, sourceAccount,
                status: 'active', // Default status
                currentValue: null, // Explicitly null initially
                redeemedAmount: null, redemptionDate: null, profitOrLoss: null
            };
            investments.push(newInvestment); saveInvestments();
            const spendTransactionForInvestment = { id: Date.now() + 1, type: 'spend', category: 'Investment Expense', description: `Investment: ${description}`, amount: amount, date: date, account: sourceAccount };
            transactions.push(spendTransactionForInvestment); saveTransactions();
            renderAllContent();
            investmentForm.reset(); setDefaultDate(investmentDateEl); if(investmentSourceAccountEl) investmentSourceAccountEl.value = ""; investmentModalJQ.modal('hide');
        });
    }
    
    // ... (Delete button click handler - same as V3, ensure renderAllContent) ...
    document.body.addEventListener('click', function(e) { 
        if (e.target.classList.contains('delete-btn')) { const id = parseInt(e.target.dataset.id), type = e.target.dataset.type; if (type === 'transaction') { if (confirm('Delete transaction?')) { transactions = transactions.filter(t => t.id !== id); saveTransactions(); renderAllContent(); } } else if (type === 'investment') { if (confirm('Delete this investment record permanently? (If redeemed, the income transaction will NOT be reversed by this action).')) { investments = investments.filter(inv => inv.id !== id); saveInvestments(); renderAllContent(); } } }
        // Below is for modal opening, this should be above this generic delete handler or use e.stopPropagation if nested.
        // For simplicity, ensure the modal opening logic is separate or handled correctly with event propagation.
        const modalTrigger = e.target.closest('.update-value-btn') || e.target.closest('.redeem-btn');
        if (modalTrigger) { /* Already handled by specific listener above */ return; }

    });

    // ... (Filter/Search Event Listeners - same as V3, ensure renderFullTransactionList) ...
    [searchDescriptionEl, searchAmountEl, filterPeriodEl].forEach(el => { if (el) el.addEventListener('input', renderFullTransactionList); });
    if (filterPeriodEl) filterPeriodEl.addEventListener('change', renderFullTransactionList);
    if (clearFiltersBtn) { clearFiltersBtn.addEventListener('click', () => { if(searchDescriptionEl) searchDescriptionEl.value = ''; if(searchAmountEl) searchAmountEl.value = ''; if(filterPeriodEl) filterPeriodEl.value = 'all'; renderFullTransactionList(); }); }

    // --- Master Render Function ---
    function renderAllContent() {
        renderAccountBalances();
        renderHomePageSummaries();
        renderFullTransactionList();
        renderInvestmentList(); // This will now show updated investment info
        if(document.getElementById('chartsView').classList.contains('active')) renderSpendChart();
    }

    // --- Initial Setup ---
    setDefaultDate(transactionDateEl);
    setDefaultDate(investmentDateEl);
    setDefaultDate(investmentRedemptionDateEl); // For redeem modal
    populateCategoryChips();
    populateAccountDropdown(redemptionDepositAccountEl); // For redeem modal
    updateTransactionFormFields();
    showView('homeView', 'Dashboard');
    renderAllContent();

    // Modal cleanup
    // ... (transactionModal, investmentModal hidden.bs.modal - same as V3) ...
    $('#transactionModal').on('hidden.bs.modal', function () { /* ... */ if(transactionForm) transactionForm.reset(); selectedCategoryInputEl.value = ''; document.querySelectorAll('#categoryChipsContainer .category-chip.active').forEach(c => c.classList.remove('active')); setDefaultDate(transactionDateEl); updateTransactionFormFields(); });
    $('#investmentModal').on('hidden.bs.modal', function () { /* ... */ if(investmentForm) investmentForm.reset(); setDefaultDate(investmentDateEl); if(investmentTypeSelect) investmentTypeSelect.value = "stock"; if(investmentSourceAccountEl) investmentSourceAccountEl.value = ""; });
    $('#updateInvestmentValueModal').on('hidden.bs.modal', function () { if(updateInvestmentValueForm) updateInvestmentValueForm.reset(); });
    $('#redeemInvestmentModal').on('hidden.bs.modal', function () { if(redeemInvestmentForm) redeemInvestmentForm.reset(); if(redeemProfitLossInfoEl) redeemProfitLossInfoEl.textContent = ''; });


}); // End DOMContentLoaded
</script>
</body>
</html>
